<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Production Line Visualiser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <script>
      (function applyApiBase() {
        window.PRODUCTION_LINE_APP_VARIANT = "manager";
        const storageKey = "production-line-api-base";
        const localApiBase = "http://localhost:4000";
        const hostedApiBase = window.location.origin;
        const localHostnames = new Set(["localhost", "127.0.0.1", "::1"]);
        const hostname = String(window.location.hostname || "").toLowerCase();
        const isLocalhost = localHostnames.has(hostname);
        const currentOrigin = String(window.location.origin || "").toLowerCase();
        const stored = String(window.localStorage.getItem(storageKey) || "").trim().replace(/\/+$/, "");

        let storedIsLocal = false;
        let storedOrigin = "";
        if (stored) {
          try {
            const parsed = new URL(stored);
            storedOrigin = String(parsed.origin || "").toLowerCase();
            storedIsLocal = localHostnames.has(String(parsed.hostname || "").toLowerCase());
          } catch {
            storedIsLocal = false;
            storedOrigin = "";
          }
        }
        const storedIsSameOrigin = storedOrigin && storedOrigin === currentOrigin;

        if (isLocalhost && stored && !storedIsLocal) {
          // Prevent stale remote overrides from breaking local login.
          try {
            window.localStorage.removeItem(storageKey);
          } catch {
            // Ignore storage access issues.
          }
        }
        if (!isLocalhost && stored && !storedIsSameOrigin) {
          // Keep hosted apps pinned to same-origin /api proxy unless explicitly same-origin.
          try {
            window.localStorage.removeItem(storageKey);
          } catch {
            // Ignore storage access issues.
          }
        }

        window.PRODUCTION_LINE_API_BASE = isLocalhost
          ? (storedIsLocal && stored ? stored : localApiBase)
          : (storedIsSameOrigin && stored ? stored : hostedApiBase);
      })();
    </script>
  </head>
  <body>
    <div id="startupLoading" class="startup-loading" aria-live="polite">
      <div class="startup-loading-card">
        <div class="startup-loading-spinner" aria-hidden="true"></div>
        <p>Loading production data...</p>
      </div>
    </div>
    <div id="homeView" class="app-shell dashboard-page">
      <div class="dashboard-shell">
        <main class="dashboard-main">
          <header class="dashboard-topbar">
            <div class="home-title-block">
              <div class="home-brand-row">
                <img
                  class="cordina-logo"
                  src="assets/cordina-logo.png"
                  alt="The Cordina Group logo"
                  loading="lazy"
                  decoding="async"
                />
              </div>
              <h1 id="homeTitle">Production Line Dashboard</h1>
            </div>
            <div class="topbar-right">
              <div id="homeUserChip" class="user-chip">
                <span id="homeUserAvatar" class="avatar-dot">M</span>
                <div>
                  <strong id="homeUserRole">Manager</strong>
                  <span id="homeUserIdentity">production@plant.local</span>
                </div>
              </div>
              <button id="managerSettingsTabBtn" class="tab-btn home-btn home-settings-tab hidden" type="button" aria-pressed="false">Settings</button>
              <button id="supervisorLogout" class="ghost-btn home-btn hidden" type="button">Logout</button>
              <button id="supervisorMobileMode" class="ghost-btn hidden" type="button">Mobile Mode</button>
              <div class="shift-toggle" role="group" aria-label="App mode">
                <button id="modeManager" type="button" class="shift-option">Manager App</button>
                <button id="modeSupervisor" type="button" class="shift-option">Supervisor App</button>
              </div>
            </div>
          </header>

          <div id="managerHome">
            <section id="managerLoginSection" class="panel">
              <h2>Manager Login</h2>
              <form id="managerLoginForm" class="form-grid">
                <input id="managerUser" placeholder="Username" required />
                <input id="managerPass" type="password" placeholder="Password" required />
                <button type="submit">Log In</button>
              </form>
            </section>

            <div id="managerAppSection" class="dashboard-grid hidden">
              <section class="dash-card analytics-card">
                <h2>Multi-Line Dashboard</h2>
                <div class="dashboard-toolbar">
                  <div class="dashboard-filter-group">
                    <label>
                      Date
                      <input id="dashboardDate" type="date" />
                    </label>
                    <label>
                      Shift
                      <div id="dashboardShiftToggle" class="shift-toggle" role="group" aria-label="Dashboard shift selector">
                        <button type="button" class="shift-option" data-dash-shift="Day">Day</button>
                        <button type="button" class="shift-option" data-dash-shift="Night">Night</button>
                        <button type="button" class="shift-option" data-dash-shift="Full Day">Full Day</button>
                      </div>
                    </label>
                  </div>
                  <button id="exportDashboardCsv" class="ghost-btn" type="button">Export Dashboard CSV</button>
                </div>
                <div class="table-wrap dashboard-table-wrap">
                  <table id="dashboardTable"></table>
                </div>
              </section>

              <section class="dash-card project-list-card manager-primary-card">
                <div class="dash-card-head">
                  <h2>Production Lines</h2>
                </div>
                <div id="lineCards" class="line-cards"></div>
              </section>

              <section class="dash-card manage-super-card manager-settings-card">
                <h2>Manage Supervisors</h2>
                <div class="action-row">
                  <button id="manageSupervisorsBtn" type="button">Manage Supervisors</button>
                  <button id="addSupervisorBtn" class="ghost-btn" type="button">Add Supervisor</button>
                </div>
                <p class="muted">Assign lines, update access, and remove supervisor accounts.</p>
              </section>

              <section class="dash-card add-line-card manager-settings-card">
                <h2>Manage Production Lines</h2>
                <div class="action-row">
                  <button id="openBuilder" type="button">+ Add Line</button>
                  <button id="manageLineGroupsBtn" class="ghost-btn" type="button">Manage Line Groups</button>
                </div>
                <p class="muted">Use the popup drag-and-drop builder to define stages and layout.</p>
              </section>

              <section class="dash-card manage-products-card manager-settings-card">
                <h2>Manage Products</h2>
                <div class="action-row">
                  <button id="manageProductCatalogBtn" class="ghost-btn" type="button">Manage Product List</button>
                </div>
                <p class="muted">Starter product catalogue for manager setup. Wiring and product add/edit flows will be connected next.</p>
                <div class="table-wrap products-table-wrap">
                  <table id="productCatalogTable">
                    <thead>
                      <tr>
                        <th>Code</th>
                        <th>Desc 1</th>
                        <th>Desc 2</th>
                        <th>Tray</th>
                        <th>Production Line</th>
                        <th>KG / tray</th>
                        <th>Trays / outer</th>
                        <th>Pack Type</th>
                        <th>KG / outer</th>
                        <th>Outer / pallet</th>
                        <th>Optimised Standard TPM</th>
                        <th>Optimised Crewing</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>310774</td><td>H/F Br/F 330g</td><td>B/Fillet Tray 0.33kg x30 H/Fresh F/FARM CRT 2</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.330</td><td>30</td><td>crate</td><td>9.900</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>310784</td><td>H/F Br/F 660g</td><td>B/Fillet Tray 0.66kg x 19 H/Fresh F/FARM CRT 2</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.660</td><td>19</td><td>crate</td><td>12.540</td><td>36</td><td>24.0</td><td>9.0</td></tr>
                      <tr><td>310794</td><td>H/F Br/F 495g</td><td>B/Fillet Tray 0.495kg x 25 H/Fresh F/FARM CRT 2</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.495</td><td>25</td><td>crate</td><td>12.375</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>312444</td><td>H/F Th/F 330g</td><td>Thigh Fil Tray 0.33kg x 30 H/Fresh F/FARM CRT 1</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.330</td><td>30</td><td>crate</td><td>9.900</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>312545</td><td>H/F Th/F 660 gm</td><td>Thigh Fil Tray 0.66kg x 19 H/Fresh F/FARM CRT 1</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.660</td><td>19</td><td>crate</td><td>12.540</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>312464</td><td>H/F Th/F 495g</td><td>Thigh Fil Tray 0.495kg x 25 H/Fresh F/FARM CRT 1</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.495</td><td>25</td><td>crate</td><td>12.375</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>315274</td><td>H/F Tenderloin 330 gm</td><td>T/Loin Tray 0.33kg x30 H/Fresh F/FARM CRT 2</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.330</td><td>30</td><td>crate</td><td>9.900</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>315284</td><td>H/F Tenderloin 660gm</td><td>T/Loin Tray 0.66kg x 19 H/Fresh F/FARM CRT 2</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.660</td><td>19</td><td>crate</td><td>12.540</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>315294</td><td>H/F Tenderloin 495 gm</td><td>T/Loin Tray 0.495kg x25 H/Fresh F/FARM CRT 2</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.495</td><td>25</td><td>crate</td><td>12.375</td><td>36</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>410572</td><td>B/Fillet Garlic &amp; Herb Tray L.T.O</td><td>B/Fillet Garlic &amp; Herb Tray 0.4kg x 12 F/FARM BOX</td><td>9x7x40</td><td>Tray Seal</td><td>0.400</td><td>12</td><td>box</td><td>4.800</td><td>48</td><td>48.0</td><td>16.0</td></tr>
                      <tr><td>414262</td><td>Tandoori Wing</td><td>Wing Nibbles Tandoori Style Try 2kg x4 F/Farm BOX</td><td>11x9x80</td><td>Tray Seal</td><td>2.000</td><td>4</td><td>box</td><td>8.000</td><td>48</td><td>36.0</td><td>9.0</td></tr>
                      <tr><td>417362</td><td>Kebab Mini Ckn H/Soy</td><td>Tray 1.2kg x 4 F/Farm BOX</td><td>11x9x60</td><td>Tray Seal</td><td>1.200</td><td>4</td><td>box</td><td>4.800</td><td>48</td><td>36.0</td><td>17.0</td></tr>
                      <tr><td>420164</td><td>Souvlaki 500gm</td><td>B/Fillet Strips Souvlaki 0.5kg x6 RSPCA Coles CRT</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.500</td><td>6</td><td>crate</td><td>3.000</td><td>72</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>420222</td><td>Thigh Fillet Mixed Cases</td><td>Chicken Thigh Fil Mixed Case 0.5kg x 9 Aldi BOX</td><td>11x7x40</td><td>Tray Seal</td><td>0.500</td><td>9</td><td>box</td><td>4.500</td><td>48</td><td>36.0</td><td>16.0</td></tr>
                      <tr><td>420404</td><td>Garlic, Herb Crumbed Breast</td><td>B/F Grlic Hrb Bttr &amp; Cmb 0.5kg x5 RSPCA Coles CRT</td><td>Foil</td><td>Tray Seal</td><td>0.500</td><td>5</td><td>crate</td><td>2.500</td><td>66</td><td>48.0</td><td>16.0</td></tr>
                      <tr><td>420422</td><td>B/Fil w P'ciutto P'migiana Core</td><td>B/Fil w P'ciutto P'migiana Core 0.5kg x9 Aldi BOX</td><td>9x7x40</td><td>Tray Seal</td><td>0.500</td><td>9</td><td>box</td><td>4.500</td><td>48</td><td>48.0</td><td>16.0</td></tr>
                      <tr><td>420434</td><td>Lemon &amp; Herb Minute x9</td><td>B/Fil Steaks Lemon &amp; Herb 0.5kg x9 RSPCA Coles CRT</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.500</td><td>9</td><td>crate</td><td>4.500</td><td>72</td><td>24.0</td><td>8.0</td></tr>
                      <tr><td>420544</td><td>Bacon &amp; Cheese Crumbed Breast</td><td>B/F Herb Crmb Chse Bacon 0.5kg x5 RSPCA Coles CRT</td><td>Foil</td><td>Tray Seal</td><td>0.500</td><td>5</td><td>crate</td><td>2.500</td><td>66</td><td>48.0</td><td>16.0</td></tr>
                      <tr><td>424104</td><td>Honey Soy Wings x8</td><td>Wing Pcs Nibble H/Soy 1kg x8 RSPCA Coles CRT</td><td>Thermo, 2 up</td><td>Thermoform</td><td>1.000</td><td>8</td><td>crate</td><td>8.000</td><td>66</td><td>16.0</td><td>9.0</td></tr>
                      <tr><td>427073</td><td>Frozen Moroccan Cous Cous</td><td>FZN B/F Mor Style Cous Cous 0.5kgx4 RSPCA Coles BOX</td><td>Thermo, 3 up split</td><td>Thermoform</td><td>0.500</td><td>4</td><td>box</td><td>2.000</td><td>128</td><td></td><td></td></tr>
                      <tr><td>427083</td><td>Frozen Prosciutto Wrap</td><td>FZN B/F Pctto Chrt Fig Jam 0.5kgx4 RSPCA Coles BOX</td><td>Thermo, 3 up split</td><td>Thermoform</td><td>0.500</td><td>4</td><td>box</td><td>2.000</td><td>128</td><td></td><td></td></tr>
                      <tr><td>427093</td><td>Frozen dAffinois Deboned Bird</td><td>FZN Ckn Stf Chse Pros HFig 1kg x3 Coles RSPCA BOX</td><td>Thermo, 2 up</td><td>Thermoform</td><td>1.000</td><td>3</td><td>box</td><td>3.000</td><td>128</td><td></td><td></td></tr>
                      <tr><td>427103</td><td>Frozen Roulade Fruit Mince</td><td>FZN Ckn Roulade Fruit Mince 0.7kgx4 Coles RSPCA BOX</td><td>Thermo, 3 up</td><td>Thermoform</td><td>0.700</td><td>4</td><td>box</td><td>2.800</td><td>128</td><td></td><td></td></tr>
                      <tr><td>427384</td><td>Boneless Greek Bird</td><td>W/B Deboned Greek Insp Mar 1kg x6 RSPCA Coles CRT</td><td>Thermo, 2 up</td><td>Thermoform</td><td>1.000</td><td>6</td><td>crate</td><td>6.000</td><td>66</td><td>16.0</td><td>9.0</td></tr>
                      <tr><td>427414</td><td>Boneless Asian Bird</td><td>W/B Deboned Asian BBQ Rub 1kg x6 RSPCA Coles CRT</td><td>Thermo, 2 up</td><td>Thermoform</td><td>1.000</td><td>6</td><td>crate</td><td>6.000</td><td>66</td><td>16.0</td><td>9.0</td></tr>
                      <tr><td>427462</td><td>Butterflied Chicken Mixed Case</td><td>Ckn Butterflied Mixed Case W/ 1.1kg x10 Aldi BOX</td><td>Thermo, 2 up</td><td>Thermoform</td><td>1.100</td><td>10</td><td>box</td><td>11.000</td><td>40</td><td>16.0</td><td>10.0</td></tr>
                      <tr><td>427484</td><td>Honey Soy Kebab</td><td>Ckn Kebab H/Soy Tray 0.75kg x8 RSPCA Coles CRT</td><td>11x7x60</td><td>Tray Seal</td><td>0.750</td><td>8</td><td>crate</td><td>6.000</td><td>36</td><td>36.0</td><td>18.0</td></tr>
                      <tr><td>427502</td><td>Souvlaki Kebabs</td><td>Kebab Thick Cut Souvlaki 0.6kg x6 RSPCA WW BOX</td><td>11x7x40</td><td>Tray Seal</td><td>0.600</td><td>6</td><td>box</td><td>3.600</td><td>72</td><td>36.0</td><td>18.0</td></tr>
                      <tr><td>427522</td><td>Sweet Chilli &amp; Lime Mini Kebabs</td><td>Kebab Mini S/Chilli Lime 0.375kg x 4 RSPCA WW BOX</td><td>8x5x50</td><td>Tray Seal</td><td>0.375</td><td>4</td><td>box</td><td>1.500</td><td>150</td><td>48.0</td><td>16.0</td></tr>
                      <tr><td>427532</td><td>Satay Mini Kebabs</td><td>Kebab Mini Satay Tray 0.375kg x 4 RSPCA WW BOX</td><td>8x5x50</td><td>Tray Seal</td><td>0.375</td><td>4</td><td>box</td><td>1.500</td><td>150</td><td>48.0</td><td>16.0</td></tr>
                      <tr><td>427642</td><td>Teriyaki Mini Kebabs</td><td>Kebab Mini Teriyaki Tray 0.375kg x 4 RSPCA WW BOX</td><td>8x5x50</td><td>Tray Seal</td><td>0.375</td><td>4</td><td>box</td><td>1.500</td><td>150</td><td>48.0</td><td>16.0</td></tr>
                      <tr><td>427654</td><td>El-Amins Greek Boneless Bird</td><td>W/Bird Debnd Greek Insp 1kg x 6 El-Amins Coles CRT</td><td>Thermo, 2 up</td><td>Thermoform</td><td>1.000</td><td>6</td><td>crate</td><td>6.000</td><td>66</td><td>16.0</td><td>9.0</td></tr>
                      <tr><td>427677</td><td>Chicken &amp; Chorizo Skewers</td><td>Kebab Mini Ckn &amp; Chorizo 0.3kg x6 RSPCA Coles CRT</td><td>8x5x50</td><td>Tray Seal</td><td>0.300</td><td>6</td><td>crate</td><td>1.800</td><td>66</td><td>48.0</td><td>15.0</td></tr>
                      <tr><td>427684</td><td>Greek Tenderloin Skewers</td><td>Skewer T/loin Greek Style 0.3kg x6 RSPCA Coles CRT</td><td>8x5x50</td><td>Tray Seal</td><td>0.300</td><td>6</td><td>crate</td><td>1.800</td><td>66</td><td>48.0</td><td>26.0</td></tr>
                      <tr><td>427694</td><td>Mini Teriyaki Kebabs</td><td>Kebab Mini Teriyaki 0.85kg x4 RSPCA Coles CRT</td><td>9x7x80</td><td>Tray Seal</td><td>0.850</td><td>4</td><td>crate</td><td>3.400</td><td>66</td><td>48.0</td><td>18.0</td></tr>
                      <tr><td>428134</td><td>Chicken Parcels</td><td>Chicken Parcels Tray 0.6kg x5 RSPCA Coles CRT</td><td>Foil</td><td>Tray Seal</td><td>0.600</td><td>5</td><td>crate</td><td>3.000</td><td>66</td><td>48.0</td><td>26.0</td></tr>
                      <tr><td>428184</td><td>B.B.Q.Ribs</td><td>Chicken Ribs Smokey BBQ 1kg x 6 RSPCA Coles CRT</td><td>Thermo, 2 up</td><td>Thermoform</td><td>1.000</td><td>6</td><td>crate</td><td>6.000</td><td>66</td><td>16.0</td><td>9.0</td></tr>
                      <tr><td>490122</td><td>Fry's Steak-style Strips</td><td>Fry's Steak Style Strips Tray 250g x 4 BOX</td><td>8x5x50</td><td>Tray Seal</td><td>0.250</td><td>4</td><td>box</td><td>1.000</td><td>150</td><td>48.0</td><td>10.0</td></tr>
                      <tr><td>490132</td><td>Fry's Chicken-style Strips</td><td>Fry's Chicken Style Strips Tray 250g x 4 BOX</td><td>8x5x50</td><td>Tray Seal</td><td>0.250</td><td>4</td><td>box</td><td>1.000</td><td>150</td><td>48.0</td><td>10.0</td></tr>
                    </tbody>
                  </table>
                </div>
              </section>

              <section class="dash-card incoming-data-sources-card manager-settings-card">
                <h2>Incoming Data Sources</h2>
                <p class="muted">Equipment feed readiness status, separate from app API connection details.</p>
                <div id="incomingDataSourcesStatus"></div>
              </section>

              <section class="dash-card data-sources-card manager-settings-card">
                <h2>Data Sources</h2>
                <p class="muted">Live SQL equipment feeds available for assignment to line stages.</p>
                <div class="action-row data-sources-actions">
                  <button id="connectDataSourceBtn" type="button">Connect Data Source</button>
                </div>
                <div id="dataSourcesList" class="table-wrap"></div>
              </section>

              <section class="dash-card manager-actions-card manager-primary-card">
                <h2>Actions</h2>
                <p class="muted">All open and historical actions across supervisors. Reassign ownership as needed.</p>
                <div id="managerActionList" class="table-wrap"></div>
              </section>
            </div>
          </div>

          <div id="supervisorHome" class="hidden">
            <section id="supervisorLoginSection" class="panel">
              <h2>Supervisor Login</h2>
              <form id="supervisorLoginForm" class="form-grid">
                <input id="supervisorUser" placeholder="Username" required />
                <input id="supervisorPass" type="password" placeholder="Password" required />
                <button id="supervisorTestLoginBtn" class="ghost-btn" type="button">Test Login</button>
                <button type="submit">Log In</button>
              </form>
              <p class="muted">Demo credentials: supervisor / supervisor123</p>
            </section>

            <section id="supervisorAppSection" class="panel hidden">
              <div class="supervisor-top-controls">
                <div class="tabs" role="tablist" aria-label="Supervisor app tabs">
                  <button class="tab-btn supervisor-main-tab-btn active" data-super-main-tab="supervisorDay" type="button">Day Visualiser</button>
                  <button class="tab-btn supervisor-main-tab-btn" data-super-main-tab="supervisorData" type="button">Data Entry</button>
                  <button class="tab-btn supervisor-main-tab-btn" data-super-main-tab="supervisorActions" type="button">Actions</button>
                </div>
                <label class="supervisor-line-select-inline">
                  Line
                  <select id="supervisorLineSelect" required></select>
                </label>
              </div>

            <section id="supervisorVisual" class="supervisor-main-panel">
              <div class="control-row">
                <button id="svPrevDay" class="ghost-btn" type="button" data-sv-prev="true">Previous Day</button>
                <label>
                  Date
                  <input id="svSelectedDate" type="date" data-sv-date="true" />
                </label>
                <label>
                  Shift
                  <div id="svShiftToggle" class="shift-toggle" role="group" aria-label="Supervisor shift selector">
                    <button type="button" class="shift-option" data-sv-shift="Day">Day</button>
                    <button type="button" class="shift-option" data-sv-shift="Night">Night</button>
                    <button type="button" class="shift-option" data-sv-shift="Full Day">Full Day</button>
                  </div>
                </label>
                <button id="svNextDay" class="ghost-btn" type="button" data-sv-next="true">Next Day</button>
              </div>
              <div class="kpi-grid">
                <article>
                  <h3>Total Units</h3>
                  <p id="svKpiUnits">0</p>
                </article>
                <article>
                  <h3>Total Downtime</h3>
                  <p id="svKpiDowntime">0 min</p>
                </article>
                <article>
                  <h3>Line Utilisation</h3>
                  <p id="svKpiUtilisation">0%</p>
                </article>
                <article>
                  <h3>Net Run Rate</h3>
                  <p id="svKpiRunRate">0 u/min</p>
                </article>
              </div>
              <section class="line-map" id="supervisorLineMap" aria-label="Supervisor production line map"></section>
            </section>

            <section id="supervisorDay" class="supervisor-main-panel active">
              <div class="control-row">
                <button id="svDayPrevDay" class="ghost-btn" type="button" data-sv-prev="true">Previous Day</button>
                <label>
                  Date
                  <input id="svDaySelectedDate" type="date" data-sv-date="true" />
                </label>
                <label>
                  Shift
                  <div id="svDayShiftToggle" class="shift-toggle" role="group" aria-label="Supervisor day visualiser shift selector">
                    <button type="button" class="shift-option" data-sv-shift="Day">Day</button>
                    <button type="button" class="shift-option" data-sv-shift="Night">Night</button>
                    <button type="button" class="shift-option" data-sv-shift="Full Day">Full Day</button>
                  </div>
                </label>
                <button id="svDayNextDay" class="ghost-btn" type="button" data-sv-next="true">Next Day</button>
              </div>
              <div class="kpi-grid">
                <article>
                  <h3>Total Units</h3>
                  <p id="svDayKpiUnits">0</p>
                </article>
                <article>
                  <h3>Total Downtime</h3>
                  <p id="svDayKpiDowntime">0 min</p>
                </article>
                <article>
                  <h3>Line Utilisation</h3>
                  <p id="svDayKpiUtilisation">0%</p>
                </article>
                <article>
                  <h3>Net Run Rate</h3>
                  <p id="svDayKpiRunRate">0 u/min</p>
                </article>
              </div>
              <section class="panel">
                <h2>Day Visualiser</h2>
                <p class="muted">Horizontal timeline with swimlanes for shift, breaks, production and downtime.</p>
                <div id="supervisorDayVisualiserCanvas" class="day-viz-canvas"></div>
              </section>
            </section>

            <section id="supervisorData" class="supervisor-main-panel">
              <div class="data-subtabs" role="tablist" aria-label="Supervisor logs">
                <button class="data-subtab-btn active" data-supervisor-tab="superShift" type="button">Log Shift</button>
                <button class="data-subtab-btn" data-supervisor-tab="superRun" type="button">Log Production Run</button>
                <button class="data-subtab-btn" data-supervisor-tab="superDown" type="button">Log Downtime</button>
              </div>

              <section id="superShift" class="data-section active">
                <form id="supervisorShiftForm" class="form-grid">
                  <input id="superShiftLogId" type="hidden" />
                  <input id="superShiftOpenBreakId" type="hidden" />
                  <input id="superShiftDate" type="date" required />
                  <select id="superShiftShift" required>
                    <option value="Day">Day</option>
                    <option value="Night">Night</option>
                  </select>
                  <input id="superShiftCrew" type="number" min="0" step="1" placeholder="Crew On Shift" required />
                  <label class="input-now-wrap" data-time-prefix="START">
                    <input id="superShiftStart" placeholder="Start Time (HH:MM)" aria-label="Shift start time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superShiftStart">Now</button>
                  </label>
                  <label class="input-now-wrap" data-time-prefix="FINISH">
                    <input id="superShiftFinish" placeholder="Finish Time (HH:MM)" aria-label="Shift finish time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superShiftFinish">Now</button>
                  </label>
                  <input id="superShiftNotes" placeholder="Notes (optional)" />
                  <div class="form-submit-actions">
                    <button id="superShiftSaveProgress" type="button">Start</button>
                  </div>
                </form>
                <div id="superShiftOpenList" class="pending-log-wrap"></div>
              </section>

              <section id="superRun" class="data-section">
                <form id="supervisorRunForm" class="form-grid">
                  <input id="superRunLogId" type="hidden" />
                  <input id="superRunCrewingPattern" type="hidden" />
                  <input id="superRunDate" type="date" required />
                  <select id="superRunProduct" required>
                    <option value="">Product Code</option>
                  </select>
                  <label class="input-now-wrap" data-time-prefix="START">
                    <input id="superRunProdStart" placeholder="Production Start Time (HH:MM)" aria-label="Production start time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superRunProdStart">Now</button>
                  </label>
                  <label class="input-now-wrap" data-time-prefix="FINISH">
                    <input id="superRunFinish" placeholder="Finish Time (HH:MM)" aria-label="Production finish time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superRunFinish">Now</button>
                  </label>
                  <input id="superRunUnits" type="number" min="0" step="1" placeholder="Units Produced" />
                  <input id="superRunNotes" placeholder="Notes (optional)" />
                  <button id="superRunCrewingPatternBtn" class="ghost-btn" type="button">Set Crewing Pattern</button>
                  <p id="superRunCrewingPatternSummary" class="run-crewing-summary">No crewing pattern set.</p>
                  <div class="form-submit-actions">
                    <button id="superRunSaveProgress" type="button">Start</button>
                  </div>
                </form>
                <div id="superRunOpenList" class="pending-log-wrap"></div>
              </section>

              <section id="superDown" class="data-section">
                <form id="supervisorDownForm" class="form-grid">
                  <input id="superDownLogId" type="hidden" />
                  <input id="superDownDate" type="date" required />
                  <label class="input-now-wrap" data-time-prefix="START">
                    <input id="superDownStart" placeholder="Downtime Start (HH:MM)" aria-label="Downtime start time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superDownStart">Now</button>
                  </label>
                  <label class="input-now-wrap" data-time-prefix="FINISH">
                    <input id="superDownFinish" placeholder="Downtime Finish (HH:MM)" aria-label="Downtime finish time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superDownFinish">Now</button>
                  </label>
                  <select id="superDownReasonCategory" required>
                    <option value="">Reason Group</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Donor Meat">Donor Meat</option>
                    <option value="People">People</option>
                    <option value="Materials">Materials</option>
                    <option value="Other">Other</option>
                  </select>
                  <select id="superDownReasonDetail" required></select>
                  <input id="superDownReasonNote" placeholder="Reason Notes (optional)" />
                  <input id="superDownNotes" placeholder="Notes (optional)" />
                  <div class="form-submit-actions">
                    <button id="superDownSaveProgress" type="button">Start</button>
                  </div>
                </form>
                <div id="superDownOpenList" class="pending-log-wrap"></div>
              </section>
              <div id="supervisorEntryList" class="table-wrap"></div>
              <div id="supervisorEntryCards" class="entry-cards hidden"></div>
            </section>

            <section id="supervisorActions" class="supervisor-main-panel">
              <section class="panel">
                <h2>Lodge Action</h2>
                <form id="supervisorActionForm" class="form-grid">
                  <select id="supervisorActionLine" required></select>
                  <select id="supervisorActionEquipment">
                    <option value="">Related Equipment (optional)</option>
                  </select>
                  <select id="supervisorActionReasonCategory">
                    <option value="">Downtime Category (optional)</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Donor Meat">Donor Meat</option>
                    <option value="People">People</option>
                    <option value="Materials">Materials</option>
                    <option value="Other">Other</option>
                  </select>
                  <select id="supervisorActionReasonDetail" disabled>
                    <option value="">Downtime Reason (optional)</option>
                  </select>
                  <select id="supervisorActionPriority" required>
                    <option value="Low">Low Priority</option>
                    <option value="Medium" selected>Medium Priority</option>
                    <option value="High">High Priority</option>
                    <option value="Critical">Critical Priority</option>
                  </select>
                  <select id="supervisorActionStatus" required>
                    <option value="Open" selected>Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Blocked">Blocked</option>
                    <option value="Completed">Completed</option>
                  </select>
                  <input id="supervisorActionDueDate" type="date" required />
                  <input id="supervisorActionTitle" placeholder="Action title" required />
                  <textarea id="supervisorActionDescription" placeholder="Description" rows="5" required></textarea>
                  <div class="form-submit-actions">
                    <button type="submit">Lodge Action</button>
                  </div>
                </form>
              </section>
              <section class="panel">
                <h2>Action Tickets</h2>
                <div id="supervisorActionList" class="table-wrap"></div>
                <div id="supervisorActionCards" class="entry-cards hidden"></div>
              </section>
            </section>
            </section>
          </div>
        </main>
      </div>
    </div>

    <div id="manageSupervisorsModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="manageSupervisorsTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="manageSupervisorsTitle">Manage Supervisors</h2>
            <p class="muted">Review line access, toggle day/night permissions, and save each supervisor.</p>
          </div>
          <button id="closeManageSupervisorsModal" class="ghost-btn" type="button">Close</button>
        </div>
        <div id="supervisorManagerList" class="data-layout"></div>
      </div>
    </div>

    <div id="manageLineGroupsModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card manage-line-groups-modal-card" role="dialog" aria-modal="true" aria-labelledby="manageLineGroupsTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="manageLineGroupsTitle">Manage Line Groups</h2>
            <p class="muted">Create groups and manually assign production lines to each group.</p>
          </div>
          <button id="closeManageLineGroupsModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="lineGroupCreateForm" class="line-group-create-form">
          <input id="newLineGroupName" placeholder="New group name" maxlength="120" required />
          <button type="submit">Create Group</button>
        </form>
        <div id="lineGroupManagerList" class="line-group-manager-list"></div>
      </div>
    </div>

    <div id="manageProductCatalogModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card manage-product-list-modal-card" role="dialog" aria-modal="true" aria-labelledby="manageProductCatalogTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="manageProductCatalogTitle">Manage Product List</h2>
            <p class="muted">Add and maintain products available for production runs.</p>
          </div>
          <div id="manageProductCatalogActions" class="action-row modal-head-actions">
            <button id="addProductBtn" type="button">Add Product</button>
            <button id="closeManageProductCatalogModal" class="ghost-btn" type="button">Close</button>
          </div>
        </div>
        <div id="manageProductCatalogContent" class="data-layout"></div>
      </div>
    </div>

    <div id="productLineAssignModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card product-line-assign-modal-card" role="dialog" aria-modal="true" aria-labelledby="productLineAssignTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="productLineAssignTitle">Assign Product Lines</h2>
            <p class="muted">Choose which production lines can run this product.</p>
          </div>
          <button id="closeProductLineAssignModal" class="ghost-btn" type="button">Close</button>
        </div>
        <p class="product-line-assign-product-wrap">Product: <strong id="productLineAssignProduct">-</strong></p>
        <div id="productLineAssignList" class="product-line-assign-list"></div>
        <div class="action-row product-line-assign-actions">
          <button id="productLineAssignSelectAll" class="ghost-btn" type="button">Select All</button>
          <button id="productLineAssignClearAll" class="ghost-btn" type="button">Clear All</button>
          <button id="productLineAssignSave" type="button">Save Lines</button>
        </div>
      </div>
    </div>

    <div id="addSupervisorModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="addSupervisorTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="addSupervisorTitle">Add Supervisor</h2>
            <p class="muted">Create a supervisor account and assign production lines and shifts.</p>
          </div>
          <button id="closeAddSupervisorModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="addSupervisorForm" class="form-grid add-supervisor-form">
          <section class="add-supervisor-section">
            <h3 class="supervisor-assignment-title">Account Details</h3>
            <div class="add-supervisor-fields">
              <label class="add-supervisor-field" for="newSupervisorName">
                <span>Name</span>
                <input id="newSupervisorName" placeholder="e.g. Jeff" required />
              </label>
              <label class="add-supervisor-field" for="newSupervisorUsername">
                <span>Username</span>
                <input id="newSupervisorUsername" placeholder="e.g. daylead" required />
              </label>
              <label class="add-supervisor-field" for="newSupervisorPassword">
                <span>Password</span>
                <input id="newSupervisorPassword" type="password" placeholder="Create password" required />
              </label>
            </div>
          </section>

          <div class="supervisor-assignment-sections add-supervisor-access">
            <section class="supervisor-assignment-group">
              <div class="add-supervisor-section-head">
                <h3 class="supervisor-assignment-title">Line and Shift Access</h3>
                <p class="muted">Choose day and/or night access for each production line.</p>
              </div>
              <div id="newSupervisorLines" class="supervisor-access-grid"></div>
            </section>
          </div>

          <div class="add-supervisor-actions">
            <button type="submit">Create Supervisor</button>
          </div>
        </form>
      </div>
    </div>

    <div id="editSupervisorModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="editSupervisorTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="editSupervisorTitle">Edit Supervisor</h2>
            <p class="muted">Update supervisor details.</p>
          </div>
          <button id="closeEditSupervisorModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="editSupervisorForm" class="form-grid">
          <input id="editSupervisorName" placeholder="Name" required />
          <input id="editSupervisorUsername" placeholder="Username" required />
          <input id="editSupervisorPassword" type="password" placeholder="New Password (optional)" />
          <button type="submit">Save Supervisor</button>
        </form>
      </div>
    </div>

    <div id="editLineModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="editLineTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="editLineTitle">Edit Production Line</h2>
            <p class="muted">Update the production line name.</p>
          </div>
          <button id="closeEditLineModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="editLineForm" class="form-grid">
          <input id="editLineName" placeholder="Line name" required />
          <div class="form-submit-actions">
            <button id="editLineDeleteBtn" class="danger" type="button">Delete Line</button>
            <button type="submit">Save Line Name</button>
          </div>
        </form>
      </div>
    </div>

    <div id="connectDataSourceModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card connect-data-source-modal-card" role="dialog" aria-modal="true" aria-labelledby="connectDataSourceTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="connectDataSourceTitle">Connect Data Source</h2>
            <p class="muted">Enter connection details so we can start integrating this feed.</p>
          </div>
          <button id="closeConnectDataSourceModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="connectDataSourceForm" class="form-grid connect-data-source-form">
          <label>
            Source Name
            <input id="connectDataSourceName" maxlength="160" placeholder="e.g. ProSeal Line 2 - MASTER" required />
          </label>
          <label>
            Source Key (optional)
            <input id="connectDataSourceKey" maxlength="160" placeholder="Auto-generated if blank" />
          </label>
          <label>
            Provider
            <select id="connectDataSourceProvider">
              <option value="sql">SQL</option>
              <option value="api">API</option>
            </select>
          </label>
          <label>
            Connection Mode
            <select id="connectDataSourceMode">
              <option value="api">API Key</option>
              <option value="sql">SQL Credentials</option>
            </select>
          </label>
          <label>
            Machine No (optional)
            <input id="connectDataSourceMachineNo" maxlength="64" />
          </label>
          <label>
            Device Name (optional)
            <input id="connectDataSourceDeviceName" maxlength="160" />
          </label>
          <label>
            Device ID (optional)
            <input id="connectDataSourceDeviceId" maxlength="160" />
          </label>
          <label>
            Scale Number (optional)
            <input id="connectDataSourceScaleNumber" maxlength="64" />
          </label>
          <div id="connectDataSourceApiFields" class="connect-data-source-field-group">
            <label>
              API Base URL
              <input id="connectDataSourceApiBaseUrl" type="url" maxlength="300" placeholder="https://example.com/api" />
            </label>
            <label>
              API Key
              <input id="connectDataSourceApiKey" type="password" maxlength="300" placeholder="Enter API key" />
            </label>
            <label>
              API Secret (optional)
              <input id="connectDataSourceApiSecret" type="password" maxlength="300" placeholder="Enter API secret" />
            </label>
          </div>
          <div id="connectDataSourceSqlFields" class="connect-data-source-field-group hidden">
            <label>
              SQL Host
              <input id="connectDataSourceSqlHost" maxlength="255" placeholder="db.example.com" />
            </label>
            <label>
              SQL Port
              <input id="connectDataSourceSqlPort" type="number" min="1" max="65535" step="1" placeholder="5432" />
            </label>
            <label>
              SQL Database
              <input id="connectDataSourceSqlDatabase" maxlength="160" placeholder="production_line" />
            </label>
            <label>
              SQL Username
              <input id="connectDataSourceSqlUsername" maxlength="160" />
            </label>
            <label>
              SQL Password
              <input id="connectDataSourceSqlPassword" type="password" maxlength="300" />
            </label>
          </div>
          <p id="connectDataSourceHelp" class="muted connect-data-source-help"></p>
          <p id="connectDataSourceTestResult" class="muted connect-data-source-help connect-data-source-test-result" aria-live="polite"></p>
          <div class="form-submit-actions">
            <button id="connectDataSourceTestBtn" class="ghost-btn" type="button">Test Connection</button>
            <button type="submit">Save Data Source</button>
          </div>
        </form>
      </div>
    </div>

    <div id="lineWorkspace" class="app-shell hidden">
      <header class="dashboard-topbar manager-workspace-topbar">
        <div class="home-title-block">
          <div class="home-brand-row">
            <img
              class="cordina-logo"
              src="assets/cordina-logo.png"
              alt="The Cordina Group logo"
              loading="lazy"
              decoding="async"
            />
          </div>
          <h1 id="appTitle">Kebab Packing Line</h1>
          <p>Shift-based production visualiser</p>
        </div>
        <div class="topbar-right manager-workspace-actions">
          <div id="lineWorkspaceUserChip" class="user-chip">
            <span class="avatar-dot">M</span>
            <div>
              <strong>Manager</strong>
              <span>production@plant.local</span>
            </div>
          </div>
          <div class="shift-toggle" role="group" aria-label="Line workspace app mode">
            <button id="lineModeManager" type="button" class="shift-option">Manager App</button>
            <button id="lineModeSupervisor" type="button" class="shift-option">Supervisor App</button>
          </div>
          <button id="goHome" class="ghost-btn home-btn" type="button" aria-label="Home">Home</button>
        </div>
      </header>
      <div class="manager-workspace-top-controls">
        <div class="tabs" role="tablist" aria-label="Primary tabs">
          <button class="tab-btn active" data-tab="visualiser" role="tab" aria-selected="true">Line Visualiser</button>
          <button class="tab-btn" data-tab="dayVisualiser" role="tab" aria-selected="false">Day Visualiser</button>
          <button class="tab-btn" data-tab="lineTrends" role="tab" aria-selected="false">Line Trends</button>
          <button class="tab-btn" data-tab="data" role="tab" aria-selected="false">Data Input</button>
          <button class="tab-btn" data-tab="settings" role="tab" aria-selected="false">Line Settings</button>
        </div>
      </div>

      <main>
        <section id="visualiser" class="tab-panel active" role="tabpanel">
          <div class="control-row">
            <button id="prevShift" class="ghost-btn" type="button">Previous Day</button>
            <label>
              Date
              <input id="selectedDate" type="date" data-manager-date="true" />
            </label>
            <label>
              Shift
              <div id="selectedShiftToggle" class="shift-toggle" role="group" aria-label="Shift selector">
                <button type="button" class="shift-option" data-shift="Day">Day</button>
                <button type="button" class="shift-option" data-shift="Night">Night</button>
                <button type="button" class="shift-option" data-shift="Full Day">Full Day</button>
              </div>
            </label>
            <button id="nextShift" class="ghost-btn" type="button">Next Day</button>
          </div>

          <div class="kpi-grid">
            <article>
              <h3>Total Units</h3>
              <p id="kpiUnits">0</p>
            </article>
            <article>
              <h3>Total Downtime</h3>
              <p id="kpiDowntime">0 min</p>
            </article>
            <article>
              <h3>Line Utilisation</h3>
              <p id="kpiUtilisation">0%</p>
            </article>
            <article>
              <h3>Net Run Rate</h3>
              <p id="kpiRunRate">0 u/min</p>
            </article>
          </div>

          <section class="line-map" id="lineMap" aria-label="Production line map"></section>
          <div class="layout-tool-row">
            <button id="toggleLayoutEdit" class="ghost-btn" type="button">Edit Layout</button>
            <button id="addFlowLine" class="ghost-btn hidden" type="button">Add Line</button>
            <button id="addFlowArrow" class="ghost-btn hidden" type="button">Add Arrow</button>
            <button id="uploadFlowShapeBtn" class="ghost-btn hidden" type="button">Upload Shape</button>
            <input id="uploadFlowShapeInput" type="file" accept="image/*" class="hidden" />
          </div>
        </section>

        <section id="dayVisualiser" class="tab-panel" role="tabpanel">
          <div class="control-row">
            <button id="dayPrevShift" class="ghost-btn" type="button">Previous Day</button>
            <label>
              Date
              <input id="daySelectedDate" type="date" data-manager-date="true" />
            </label>
            <label>
              Shift
              <div id="daySelectedShiftToggle" class="shift-toggle" role="group" aria-label="Day visualiser shift selector">
                <button type="button" class="shift-option" data-day-shift="Day">Day</button>
                <button type="button" class="shift-option" data-day-shift="Night">Night</button>
                <button type="button" class="shift-option" data-day-shift="Full Day">Full Day</button>
              </div>
            </label>
            <button id="dayNextShift" class="ghost-btn" type="button">Next Day</button>
          </div>

          <div class="kpi-grid">
            <article>
              <h3>Total Units</h3>
              <p id="dayKpiUnits">0</p>
            </article>
            <article>
              <h3>Total Downtime</h3>
              <p id="dayKpiDowntime">0 min</p>
            </article>
            <article>
              <h3>Line Utilisation</h3>
              <p id="dayKpiUtilisation">0%</p>
            </article>
            <article>
              <h3>Net Run Rate</h3>
              <p id="dayKpiRunRate">0 u/min</p>
            </article>
          </div>
          <section class="panel">
            <h2>Day Visualiser</h2>
            <p class="muted">Horizontal timeline with swimlanes for shift, breaks, production and downtime.</p>
            <div id="dayVisualiserCanvas" class="day-viz-canvas"></div>
          </section>
        </section>

        <section id="lineTrends" class="tab-panel" role="tabpanel">
          <div class="control-row">
            <button id="lineTrendPrevPeriod" class="ghost-btn" type="button">Previous Period</button>
            <label>
              Date
              <input id="lineTrendSelectedDate" type="date" data-manager-date="true" />
            </label>
            <label>
              Shift
              <div id="lineTrendShiftToggle" class="shift-toggle" role="group" aria-label="Line trends shift selector">
                <button type="button" class="shift-option" data-day-shift="Day">Day</button>
                <button type="button" class="shift-option" data-day-shift="Night">Night</button>
                <button type="button" class="shift-option" data-day-shift="Full Day">Full Day</button>
              </div>
            </label>
            <button id="lineTrendNextPeriod" class="ghost-btn" type="button">Next Period</button>
          </div>

          <section class="panel line-trend-shell">
            <div class="line-trend-toolbar">
              <div class="line-trend-range" role="group" aria-label="Line trend range">
                <button type="button" class="ghost-btn" data-line-trend-range="day">Day</button>
                <button type="button" class="ghost-btn" data-line-trend-range="week">Week</button>
                <button type="button" class="ghost-btn" data-line-trend-range="month">Month</button>
                <button type="button" class="ghost-btn" data-line-trend-range="quarter">Quarter</button>
              </div>
              <p id="lineTrendRangeMeta" class="muted"></p>
            </div>

            <div class="line-trend-kpis">
              <article>
                <h3>Units (Current)</h3>
                <p id="lineTrendKpiUnits">0</p>
              </article>
              <article>
                <h3>Downtime (Current)</h3>
                <p id="lineTrendKpiDowntime">0 min</p>
              </article>
              <article>
                <h3>Utilisation (Current)</h3>
                <p id="lineTrendKpiUtilisation">0%</p>
              </article>
              <article>
                <h3>Net Run Rate (Current)</h3>
                <p id="lineTrendKpiRunRate">0 u/min</p>
              </article>
            </div>

            <div class="line-trend-grid">
              <section class="line-trend-panel">
                <h3>Units By Period</h3>
                <div id="lineTrendUnitsChart" class="trend-chart line-trend-chart"></div>
              </section>
              <section class="line-trend-panel">
                <h3>Utilisation and Downtime</h3>
                <div id="lineTrendUtilDownChart" class="trend-chart line-trend-chart"></div>
              </section>
            </div>

            <section class="line-trend-panel">
              <h3>Top Downtime Reasons In Window</h3>
              <div id="lineTrendTopReasons" class="line-trend-reasons"></div>
            </section>
          </section>
        </section>

        <section id="data" class="tab-panel" role="tabpanel">
          <div class="data-layout">
            <div class="data-subtabs" role="tablist" aria-label="Data sections">
              <button class="data-subtab-btn active" data-data-tab="dataShift" type="button">Shift Tracking</button>
              <button class="data-subtab-btn" data-data-tab="dataRun" type="button">Product Runs</button>
              <button class="data-subtab-btn" data-data-tab="dataDown" type="button">Downtime</button>
              <button class="data-subtab-btn" data-data-tab="dataControls" type="button">Controls</button>
            </div>

            <section id="dataShift" class="panel data-section active">
              <h2>Shift Tracking</h2>
              <form id="shiftForm" class="form-grid">
                <input name="date" type="date" required />
                <select name="shift" required>
                  <option value="Day">Day</option>
                  <option value="Night">Night</option>
                  <option value="Full Day">Full Day</option>
                </select>
                <input name="crewOnShift" type="number" min="0" step="1" placeholder="Crew On Shift" required />
                <input name="startTime" placeholder="Start Time" />
                <input name="finishTime" placeholder="Finish Time" />
                <input name="notes" placeholder="Notes (optional)" />
                <button type="submit">Add Shift Row</button>
              </form>
              <div class="table-wrap"><table id="shiftTable"></table></div>
            </section>

            <section id="dataRun" class="panel data-section">
              <h2>Product Run Tracking</h2>
              <form id="runForm" class="form-grid">
                <input id="runCrewingPattern" name="runCrewingPattern" type="hidden" />
                <input name="date" type="date" required />
                <input name="product" placeholder="Product" required />
                <input name="productionStartTime" placeholder="Production Start Time" />
                <input name="finishTime" placeholder="Finish Time" />
                <input name="unitsProduced" type="number" step="1" placeholder="Units Produced" />
                <input name="notes" placeholder="Notes (optional)" />
                <button id="runCrewingPatternBtn" class="ghost-btn" type="button">Set Crewing Pattern</button>
                <p id="runCrewingPatternSummary" class="run-crewing-summary">No crewing pattern set.</p>
                <button type="submit">Add Product Row</button>
              </form>
              <div class="table-wrap"><table id="runTable"></table></div>
            </section>

            <section id="dataDown" class="panel data-section">
              <h2>Downtime Tracking</h2>
              <form id="downtimeForm" class="form-grid">
                <input name="date" type="date" required />
                <input name="downtimeStart" placeholder="Downtime Start" />
                <input name="downtimeFinish" placeholder="Downtime Finish" />
                <select name="reasonCategory" id="downtimeReasonCategory" required>
                  <option value="">Reason Group</option>
                  <option value="Equipment">Equipment</option>
                  <option value="Donor Meat">Donor Meat</option>
                  <option value="People">People</option>
                  <option value="Materials">Materials</option>
                  <option value="Other">Other</option>
                </select>
                <select name="reasonDetail" id="downtimeReasonDetail" required></select>
                <input name="reasonNote" id="downtimeReasonNote" placeholder="Reason Notes (optional)" />
                <input name="notes" id="downtimeNotes" placeholder="Notes (optional)" />
                <button type="submit">Add Downtime Row</button>
              </form>
              <div class="table-wrap"><table id="downtimeTable"></table></div>
            </section>

            <section id="dataControls" class="panel data-section">
              <h2>Data Controls</h2>
              <div class="action-row">
                <button id="loadSampleData" type="button">Load Sample Data</button>
                <button id="loadPermanentSampleData" type="button">Load Permanent Sample Data</button>
                <button id="exportData" type="button">Export JSON</button>
                <button id="exportLineCsv" class="ghost-btn" type="button">Export CSV Report</button>
                <label class="import-label">
                  Import JSON
                  <input id="importData" type="file" accept="application/json" />
                </label>
                <button id="clearData" class="danger" type="button">Clear All</button>
              </div>
              <div id="auditTrail" class="table-wrap"></div>
            </section>
          </div>
        </section>

        <section id="settings" class="tab-panel" role="tabpanel">
          <div class="data-layout">
            <section class="panel">
              <h2>Stage Crew Settings</h2>
              <div class="crew-toggle-wrap">
                <span class="muted">Crew Shift</span>
                <div class="shift-toggle" role="group" aria-label="Crew shift selector">
                  <button type="button" class="shift-option" data-crew-shift="Day">Day</button>
                  <button type="button" class="shift-option" data-crew-shift="Night">Night</button>
                </div>
              </div>
              <p class="muted" id="crewShiftNote">Crew values for Day shift.</p>
              <form id="crewForm" class="crew-grid"></form>
            </section>

            <section class="panel">
              <h2>Stage Max Throughput</h2>
              <p class="muted">Units/min per crew member. Total stage max = (per-crew max) x (crew count).</p>
              <form id="throughputForm" class="crew-grid"></form>
              <div class="action-row stage-settings-save-row">
                <button id="saveStageCrewSettingsBtn" type="button">Save Stage Settings</button>
                <span id="stageCrewSaveStatus" class="muted stage-settings-save-status">All stage settings saved.</span>
              </div>
            </section>
          </div>
        </section>
      </main>
    </div>

    <div id="trendModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="trendTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="trendTitle">Stage Performance Trend</h2>
            <p class="muted" id="trendMeta">Click a stage to view performance over time.</p>
          </div>
          <div class="trend-controls">
            <div class="shift-toggle" role="group" aria-label="Trend view mode">
              <button id="trendDaily" type="button" class="shift-option">Daily</button>
              <button id="trendMonthly" type="button" class="shift-option">Monthly</button>
            </div>
            <div class="month-nav">
              <button id="trendPrevMonth" class="ghost-btn" type="button">Prev</button>
              <span id="trendMonthLabel">-</span>
              <button id="trendNextMonth" class="ghost-btn" type="button">Next</button>
            </div>
            <button id="closeTrendModal" class="ghost-btn" type="button">Close</button>
          </div>
        </div>
        <div id="stageTrendChart" class="trend-chart" aria-live="polite"></div>
      </div>
    </div>

    <div id="stageSettingsModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="stageSettingsTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="stageSettingsTitle">Edit Stage</h2>
            <p class="muted">Update this stage for the current production line.</p>
          </div>
          <button id="closeStageSettingsModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="stageSettingsForm" class="form-grid">
          <input type="hidden" id="stageSettingsId" />
          <label>
            Stage Name
            <input id="stageSettingsName" required />
          </label>
          <label>
            Type
            <select id="stageSettingsType">
              <option value="main">Main</option>
              <option value="prep">Prep</option>
              <option value="transfer">Transfer</option>
            </select>
          </label>
          <label>
            Connect To Data Source
            <select id="stageSettingsDataSource">
              <option value="">Not connected</option>
            </select>
          </label>
          <p id="stageSettingsDataSourceHint" class="muted stage-data-source-hint"></p>
          <label>
            Day Crew
            <input id="stageSettingsCrewDay" type="number" min="0" step="1" />
          </label>
          <label>
            Night Crew
            <input id="stageSettingsCrewNight" type="number" min="0" step="1" />
          </label>
          <label>
            Max Throughput (u/min per crew)
            <input id="stageSettingsMaxThroughput" type="number" min="0" step="1" />
          </label>
          <label>
            Width (%)
            <input id="stageSettingsWidth" type="number" min="2" step="0.1" />
          </label>
          <label>
            Height (%)
            <input id="stageSettingsHeight" type="number" min="1" step="0.1" />
          </label>
          <button id="saveStageSettings" type="submit">Save Stage</button>
        </form>
      </div>
    </div>

    <div id="runCrewingPatternModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="runCrewingPatternTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="runCrewingPatternTitle">Set Crewing Pattern</h2>
            <p id="runCrewingPatternMeta" class="muted">Set crew values for each non-transfer stage on this run.</p>
          </div>
          <button id="closeRunCrewingPatternModal" class="ghost-btn" type="button">Close</button>
        </div>
        <div id="runCrewingPatternList" class="run-crewing-stage-list"></div>
        <div class="run-crewing-actions">
          <button id="saveRunCrewingPattern" type="button">Save Crewing Pattern</button>
        </div>
      </div>
    </div>

    <div id="builderModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card builder-modal-card" role="dialog" aria-modal="true" aria-labelledby="builderTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="builderTitle">Production Line Builder</h2>
            <p class="muted">Drag stages on the canvas, edit stage settings, then create the line.</p>
          </div>
          <div class="trend-controls">
            <button id="addBuilderStage" type="button">Add Stage</button>
            <button id="createBuilderLine" type="button">Create Line</button>
            <button id="closeBuilderModal" class="ghost-btn" type="button">Close</button>
          </div>
        </div>

        <div class="builder-grid">
          <section class="panel">
            <h3>Line Setup</h3>
            <input id="builderLineName" placeholder="Line Name (e.g. Kebab Line A)" />
            <div class="builder-row builder-row-head">
              <span>#</span>
              <span>Stage Name</span>
              <span>Type</span>
              <span>Crew</span>
              <span>Per-Crew u/min</span>
              <span>Action</span>
            </div>
            <div id="builderStages" class="builder-stages"></div>
          </section>
          <section class="panel">
            <h3>Layout Canvas</h3>
            <div id="builderCanvas" class="builder-canvas"></div>
          </section>
        </div>
      </div>
    </div>

    <script src="app.js"></script>
  </body>
</html>
