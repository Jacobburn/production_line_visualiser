<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Production Line Visualiser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <script>
      (function applyApiBase() {
        const stored = String(window.localStorage.getItem("production-line-api-base") || "").trim().replace(/\/+$/, "");
        const isLocalhost = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        window.PRODUCTION_LINE_API_BASE = stored || (isLocalhost ? "http://localhost:4000" : "https://production-line-api-staging.onrender.com");
      })();
    </script>
  </head>
  <body>
    <div id="startupLoading" class="startup-loading" aria-live="polite">
      <div class="startup-loading-card">
        <div class="startup-loading-spinner" aria-hidden="true"></div>
        <p>Loading production data...</p>
      </div>
    </div>
    <div id="homeView" class="app-shell dashboard-page">
      <div class="dashboard-shell">
        <main class="dashboard-main">
          <header class="dashboard-topbar">
            <div class="home-title-block">
              <div class="home-brand-row">
                <img
                  class="cordina-logo"
                  src="assets/cordina-logo.png"
                  alt="The Cordina Group logo"
                  loading="lazy"
                  decoding="async"
                />
              </div>
              <h1 id="homeTitle">Production Line Dashboard</h1>
              <p>Select a production line or build a new one</p>
            </div>
            <div class="topbar-right">
              <div id="homeUserChip" class="user-chip">
                <span id="homeUserAvatar" class="avatar-dot">M</span>
                <div>
                  <strong id="homeUserRole">Manager</strong>
                  <span id="homeUserIdentity">production@plant.local</span>
                </div>
              </div>
              <button id="supervisorLogout" class="ghost-btn home-btn hidden" type="button">Logout</button>
              <button id="supervisorMobileMode" class="ghost-btn hidden" type="button">Mobile Mode</button>
              <div class="shift-toggle" role="group" aria-label="App mode">
                <button id="modeManager" type="button" class="shift-option">Manager App</button>
                <button id="modeSupervisor" type="button" class="shift-option">Supervisor App</button>
              </div>
            </div>
          </header>

          <div id="managerHome">
            <section id="managerLoginSection" class="panel">
              <h2>Manager Login</h2>
              <form id="managerLoginForm" class="form-grid">
                <input id="managerUser" placeholder="Username" required />
                <input id="managerPass" type="password" placeholder="Password" required />
                <button id="managerTestLoginBtn" class="ghost-btn" type="button">Test Login</button>
                <button type="submit">Log In</button>
              </form>
              <p class="muted">Demo credentials: manager / manager123</p>
            </section>

            <div id="managerAppSection" class="dashboard-grid hidden">
              <section class="dash-card analytics-card">
                <h2>Multi-Line Dashboard</h2>
                <div class="dashboard-toolbar">
                  <div class="dashboard-filter-group">
                    <label>
                      Date
                      <input id="dashboardDate" type="date" />
                    </label>
                    <label>
                      Shift
                      <div id="dashboardShiftToggle" class="shift-toggle" role="group" aria-label="Dashboard shift selector">
                        <button type="button" class="shift-option" data-dash-shift="Day">Day</button>
                        <button type="button" class="shift-option" data-dash-shift="Night">Night</button>
                        <button type="button" class="shift-option" data-dash-shift="Full Day">Full Day</button>
                      </div>
                    </label>
                  </div>
                  <button id="exportDashboardCsv" class="ghost-btn" type="button">Export Dashboard CSV</button>
                </div>
                <div class="table-wrap dashboard-table-wrap">
                  <table id="dashboardTable"></table>
                </div>
              </section>

              <section class="dash-card project-list-card">
                <div class="dash-card-head">
                  <h2>Production Lines</h2>
                </div>
                <div id="lineCards" class="line-cards"></div>
              </section>

              <section class="dash-card manage-super-card">
                <h2>Manage Supervisors</h2>
                <div class="action-row">
                  <button id="manageSupervisorsBtn" type="button">Manage Supervisors</button>
                  <button id="addSupervisorBtn" class="ghost-btn" type="button">Add Supervisor</button>
                </div>
                <p class="muted">Assign lines, update access, and remove supervisor accounts.</p>
              </section>

              <section class="dash-card add-line-card">
                <h2>Manage Production Lines</h2>
                <div class="action-row">
                  <button id="openBuilder" type="button">+ Add Line</button>
                  <button id="manageLineGroupsBtn" class="ghost-btn" type="button">Manage Line Groups</button>
                </div>
                <p class="muted">Use the popup drag-and-drop builder to define stages and layout.</p>
              </section>
            </div>
          </div>

          <div id="supervisorHome" class="hidden">
            <section id="supervisorLoginSection" class="panel">
              <h2>Supervisor Login</h2>
              <form id="supervisorLoginForm" class="form-grid">
                <input id="supervisorUser" placeholder="Username" required />
                <input id="supervisorPass" type="password" placeholder="Password" required />
                <button id="supervisorTestLoginBtn" class="ghost-btn" type="button">Test Login</button>
                <button type="submit">Log In</button>
              </form>
              <p class="muted">Demo credentials: supervisor / supervisor123</p>
            </section>

            <section id="supervisorAppSection" class="panel hidden">
              <div class="supervisor-top-controls">
                <div class="tabs" role="tablist" aria-label="Supervisor app tabs">
                  <button class="tab-btn supervisor-main-tab-btn active" data-super-main-tab="supervisorDay" type="button">Day Visualiser</button>
                  <button class="tab-btn supervisor-main-tab-btn" data-super-main-tab="supervisorData" type="button">Data Entry</button>
                </div>
                <label class="supervisor-line-select-inline">
                  Line
                  <select id="supervisorLineSelect" required></select>
                </label>
              </div>

            <section id="supervisorVisual" class="supervisor-main-panel">
              <div class="control-row">
                <button id="svPrevDay" class="ghost-btn" type="button" data-sv-prev="true">Previous Day</button>
                <label>
                  Date
                  <input id="svSelectedDate" type="date" data-sv-date="true" />
                </label>
                <label>
                  Shift
                  <div id="svShiftToggle" class="shift-toggle" role="group" aria-label="Supervisor shift selector">
                    <button type="button" class="shift-option" data-sv-shift="Day">Day</button>
                    <button type="button" class="shift-option" data-sv-shift="Night">Night</button>
                    <button type="button" class="shift-option" data-sv-shift="Full Day">Full Day</button>
                  </div>
                </label>
                <button id="svNextDay" class="ghost-btn" type="button" data-sv-next="true">Next Day</button>
              </div>
              <div class="kpi-grid">
                <article>
                  <h3>Total Units</h3>
                  <p id="svKpiUnits">0</p>
                </article>
                <article>
                  <h3>Total Downtime</h3>
                  <p id="svKpiDowntime">0 min</p>
                </article>
                <article>
                  <h3>Line Utilisation</h3>
                  <p id="svKpiUtilisation">0%</p>
                </article>
                <article>
                  <h3>Net Run Rate</h3>
                  <p id="svKpiRunRate">0 u/min</p>
                </article>
              </div>
              <section class="line-map" id="supervisorLineMap" aria-label="Supervisor production line map"></section>
            </section>

            <section id="supervisorDay" class="supervisor-main-panel active">
              <div class="control-row">
                <button id="svDayPrevDay" class="ghost-btn" type="button" data-sv-prev="true">Previous Day</button>
                <label>
                  Date
                  <input id="svDaySelectedDate" type="date" data-sv-date="true" />
                </label>
                <label>
                  Shift
                  <div id="svDayShiftToggle" class="shift-toggle" role="group" aria-label="Supervisor day visualiser shift selector">
                    <button type="button" class="shift-option" data-sv-shift="Day">Day</button>
                    <button type="button" class="shift-option" data-sv-shift="Night">Night</button>
                    <button type="button" class="shift-option" data-sv-shift="Full Day">Full Day</button>
                  </div>
                </label>
                <button id="svDayNextDay" class="ghost-btn" type="button" data-sv-next="true">Next Day</button>
              </div>
              <div class="kpi-grid">
                <article>
                  <h3>Total Units</h3>
                  <p id="svDayKpiUnits">0</p>
                </article>
                <article>
                  <h3>Total Downtime</h3>
                  <p id="svDayKpiDowntime">0 min</p>
                </article>
                <article>
                  <h3>Line Utilisation</h3>
                  <p id="svDayKpiUtilisation">0%</p>
                </article>
                <article>
                  <h3>Net Run Rate</h3>
                  <p id="svDayKpiRunRate">0 u/min</p>
                </article>
              </div>
              <section class="panel">
                <h2>Day Visualiser</h2>
                <p class="muted">Horizontal timeline with swimlanes for shift, breaks, production and downtime.</p>
                <div id="supervisorDayVisualiserCanvas" class="day-viz-canvas"></div>
              </section>
            </section>

            <section id="supervisorData" class="supervisor-main-panel">
              <div class="data-subtabs" role="tablist" aria-label="Supervisor logs">
                <button class="data-subtab-btn active" data-supervisor-tab="superShift" type="button">Log Shift</button>
                <button class="data-subtab-btn" data-supervisor-tab="superRun" type="button">Log Production Run</button>
                <button class="data-subtab-btn" data-supervisor-tab="superDown" type="button">Log Downtime</button>
              </div>

              <section id="superShift" class="data-section active">
                <form id="supervisorShiftForm" class="form-grid">
                  <input id="superShiftLogId" type="hidden" />
                  <input id="superShiftOpenBreakId" type="hidden" />
                  <input id="superShiftDate" type="date" required />
                  <select id="superShiftShift" required>
                    <option value="Day">Day</option>
                    <option value="Night">Night</option>
                  </select>
                  <input id="superShiftCrew" type="number" min="0" step="1" placeholder="Crew On Shift" required />
                  <label class="input-now-wrap" data-time-prefix="START">
                    <input id="superShiftStart" placeholder="Start Time (HH:MM)" aria-label="Shift start time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superShiftStart">Now</button>
                  </label>
                  <label class="input-now-wrap" data-time-prefix="FINISH">
                    <input id="superShiftFinish" placeholder="Finish Time (HH:MM)" aria-label="Shift finish time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superShiftFinish">Now</button>
                  </label>
                  <div class="form-submit-actions">
                    <button id="superShiftSaveProgress" type="button">Start</button>
                  </div>
                </form>
                <div id="superShiftOpenList" class="pending-log-wrap"></div>
              </section>

              <section id="superRun" class="data-section">
                <form id="supervisorRunForm" class="form-grid">
                  <input id="superRunLogId" type="hidden" />
                  <input id="superRunCrewingPattern" type="hidden" />
                  <input id="superRunDate" type="date" required />
                  <input id="superRunProduct" placeholder="Product" required />
                  <label class="input-now-wrap" data-time-prefix="START">
                    <input id="superRunProdStart" placeholder="Production Start Time (HH:MM)" aria-label="Production start time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superRunProdStart">Now</button>
                  </label>
                  <label class="input-now-wrap" data-time-prefix="FINISH">
                    <input id="superRunFinish" placeholder="Finish Time (HH:MM)" aria-label="Production finish time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superRunFinish">Now</button>
                  </label>
                  <input id="superRunUnits" type="number" min="0" step="1" placeholder="Units Produced" />
                  <button id="superRunCrewingPatternBtn" class="ghost-btn" type="button">Set Crewing Pattern</button>
                  <p id="superRunCrewingPatternSummary" class="run-crewing-summary">No crewing pattern set.</p>
                  <div class="form-submit-actions">
                    <button id="superRunSaveProgress" type="button">Start</button>
                  </div>
                </form>
                <div id="superRunOpenList" class="pending-log-wrap"></div>
              </section>

              <section id="superDown" class="data-section">
                <form id="supervisorDownForm" class="form-grid">
                  <input id="superDownLogId" type="hidden" />
                  <input id="superDownDate" type="date" required />
                  <label class="input-now-wrap" data-time-prefix="START">
                    <input id="superDownStart" placeholder="Downtime Start (HH:MM)" aria-label="Downtime start time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superDownStart">Now</button>
                  </label>
                  <label class="input-now-wrap" data-time-prefix="FINISH">
                    <input id="superDownFinish" placeholder="Downtime Finish (HH:MM)" aria-label="Downtime finish time" />
                    <button type="button" class="ghost-btn input-now-btn" data-now-target="superDownFinish">Now</button>
                  </label>
                  <select id="superDownReasonCategory" required>
                    <option value="">Reason Group</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Donor Meat">Donor Meat</option>
                    <option value="People">People</option>
                    <option value="Materials">Materials</option>
                    <option value="Other">Other</option>
                  </select>
                  <select id="superDownReasonDetail" required></select>
                  <input id="superDownReasonNote" placeholder="Reason Notes (optional)" />
                  <div class="form-submit-actions">
                    <button id="superDownSaveProgress" type="button">Start</button>
                  </div>
                </form>
                <div id="superDownOpenList" class="pending-log-wrap"></div>
              </section>
              <div id="supervisorEntryList" class="table-wrap"></div>
              <div id="supervisorEntryCards" class="entry-cards hidden"></div>
            </section>
            </section>
          </div>
        </main>
      </div>
    </div>

    <div id="manageSupervisorsModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="manageSupervisorsTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="manageSupervisorsTitle">Manage Supervisors</h2>
            <p class="muted">Review line access, toggle day/night permissions, and save each supervisor.</p>
          </div>
          <button id="closeManageSupervisorsModal" class="ghost-btn" type="button">Close</button>
        </div>
        <div id="supervisorManagerList" class="data-layout"></div>
      </div>
    </div>

    <div id="manageLineGroupsModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card manage-line-groups-modal-card" role="dialog" aria-modal="true" aria-labelledby="manageLineGroupsTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="manageLineGroupsTitle">Manage Line Groups</h2>
            <p class="muted">Create groups and manually assign production lines to each group.</p>
          </div>
          <button id="closeManageLineGroupsModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="lineGroupCreateForm" class="line-group-create-form">
          <input id="newLineGroupName" placeholder="New group name" maxlength="120" required />
          <button type="submit">Create Group</button>
        </form>
        <div id="lineGroupManagerList" class="line-group-manager-list"></div>
      </div>
    </div>

    <div id="addSupervisorModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="addSupervisorTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="addSupervisorTitle">Add Supervisor</h2>
            <p class="muted">Create a supervisor account and assign production lines and shifts.</p>
          </div>
          <button id="closeAddSupervisorModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="addSupervisorForm" class="form-grid add-supervisor-form">
          <section class="add-supervisor-section">
            <h3 class="supervisor-assignment-title">Account Details</h3>
            <div class="add-supervisor-fields">
              <label class="add-supervisor-field" for="newSupervisorName">
                <span>Name</span>
                <input id="newSupervisorName" placeholder="e.g. Jeff" required />
              </label>
              <label class="add-supervisor-field" for="newSupervisorUsername">
                <span>Username</span>
                <input id="newSupervisorUsername" placeholder="e.g. daylead" required />
              </label>
              <label class="add-supervisor-field" for="newSupervisorPassword">
                <span>Password</span>
                <input id="newSupervisorPassword" type="password" placeholder="Create password" required />
              </label>
            </div>
          </section>

          <div class="supervisor-assignment-sections add-supervisor-access">
            <section class="supervisor-assignment-group">
              <div class="add-supervisor-section-head">
                <h3 class="supervisor-assignment-title">Line and Shift Access</h3>
                <p class="muted">Choose day and/or night access for each production line.</p>
              </div>
              <div id="newSupervisorLines" class="supervisor-access-grid"></div>
            </section>
          </div>

          <div class="add-supervisor-actions">
            <button type="submit">Create Supervisor</button>
          </div>
        </form>
      </div>
    </div>

    <div id="editSupervisorModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="editSupervisorTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="editSupervisorTitle">Edit Supervisor</h2>
            <p class="muted">Update supervisor details.</p>
          </div>
          <button id="closeEditSupervisorModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="editSupervisorForm" class="form-grid">
          <input id="editSupervisorName" placeholder="Name" required />
          <input id="editSupervisorUsername" placeholder="Username" required />
          <input id="editSupervisorPassword" type="password" placeholder="New Password (optional)" />
          <button type="submit">Save Supervisor</button>
        </form>
      </div>
    </div>

    <div id="editLineModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="editLineTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="editLineTitle">Edit Production Line</h2>
            <p class="muted">Update the production line name.</p>
          </div>
          <button id="closeEditLineModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="editLineForm" class="form-grid">
          <input id="editLineName" placeholder="Line name" required />
          <button type="submit">Save Line Name</button>
        </form>
      </div>
    </div>

    <div id="lineWorkspace" class="app-shell hidden">
      <header class="dashboard-topbar manager-workspace-topbar">
        <div class="home-title-block">
          <div class="home-brand-row">
            <img
              class="cordina-logo"
              src="assets/cordina-logo.png"
              alt="The Cordina Group logo"
              loading="lazy"
              decoding="async"
            />
          </div>
          <h1 id="appTitle">Kebab Packing Line</h1>
          <p>Shift-based production visualiser</p>
        </div>
        <div class="topbar-right manager-workspace-actions">
          <div id="lineWorkspaceUserChip" class="user-chip">
            <span class="avatar-dot">M</span>
            <div>
              <strong>Manager</strong>
              <span>production@plant.local</span>
            </div>
          </div>
          <div class="shift-toggle" role="group" aria-label="Line workspace app mode">
            <button id="lineModeManager" type="button" class="shift-option">Manager App</button>
            <button id="lineModeSupervisor" type="button" class="shift-option">Supervisor App</button>
          </div>
          <button id="goHome" class="ghost-btn home-btn" type="button" aria-label="Home">Home</button>
        </div>
      </header>
      <div class="manager-workspace-top-controls">
        <div class="tabs" role="tablist" aria-label="Primary tabs">
          <button class="tab-btn active" data-tab="visualiser" role="tab" aria-selected="true">Line Visualiser</button>
          <button class="tab-btn" data-tab="dayVisualiser" role="tab" aria-selected="false">Day Visualiser</button>
          <button class="tab-btn" data-tab="lineTrends" role="tab" aria-selected="false">Line Trends</button>
          <button class="tab-btn" data-tab="data" role="tab" aria-selected="false">Data Input</button>
          <button class="tab-btn" data-tab="settings" role="tab" aria-selected="false">Line Settings</button>
        </div>
      </div>

      <main>
        <section id="visualiser" class="tab-panel active" role="tabpanel">
          <div class="control-row">
            <button id="prevShift" class="ghost-btn" type="button">Previous Day</button>
            <label>
              Date
              <input id="selectedDate" type="date" data-manager-date="true" />
            </label>
            <label>
              Shift
              <div id="selectedShiftToggle" class="shift-toggle" role="group" aria-label="Shift selector">
                <button type="button" class="shift-option" data-shift="Day">Day</button>
                <button type="button" class="shift-option" data-shift="Night">Night</button>
                <button type="button" class="shift-option" data-shift="Full Day">Full Day</button>
              </div>
            </label>
            <button id="nextShift" class="ghost-btn" type="button">Next Day</button>
          </div>

          <div class="kpi-grid">
            <article>
              <h3>Total Units</h3>
              <p id="kpiUnits">0</p>
            </article>
            <article>
              <h3>Total Downtime</h3>
              <p id="kpiDowntime">0 min</p>
            </article>
            <article>
              <h3>Line Utilisation</h3>
              <p id="kpiUtilisation">0%</p>
            </article>
            <article>
              <h3>Net Run Rate</h3>
              <p id="kpiRunRate">0 u/min</p>
            </article>
          </div>

          <section class="line-map" id="lineMap" aria-label="Production line map"></section>
          <div class="layout-tool-row">
            <button id="toggleLayoutEdit" class="ghost-btn" type="button">Edit Layout</button>
            <button id="addFlowLine" class="ghost-btn hidden" type="button">Add Line</button>
            <button id="addFlowArrow" class="ghost-btn hidden" type="button">Add Arrow</button>
            <button id="uploadFlowShapeBtn" class="ghost-btn hidden" type="button">Upload Shape</button>
            <input id="uploadFlowShapeInput" type="file" accept="image/*" class="hidden" />
          </div>
        </section>

        <section id="dayVisualiser" class="tab-panel" role="tabpanel">
          <div class="control-row">
            <button id="dayPrevShift" class="ghost-btn" type="button">Previous Day</button>
            <label>
              Date
              <input id="daySelectedDate" type="date" data-manager-date="true" />
            </label>
            <label>
              Shift
              <div id="daySelectedShiftToggle" class="shift-toggle" role="group" aria-label="Day visualiser shift selector">
                <button type="button" class="shift-option" data-day-shift="Day">Day</button>
                <button type="button" class="shift-option" data-day-shift="Night">Night</button>
                <button type="button" class="shift-option" data-day-shift="Full Day">Full Day</button>
              </div>
            </label>
            <button id="dayNextShift" class="ghost-btn" type="button">Next Day</button>
          </div>

          <div class="kpi-grid">
            <article>
              <h3>Total Units</h3>
              <p id="dayKpiUnits">0</p>
            </article>
            <article>
              <h3>Total Downtime</h3>
              <p id="dayKpiDowntime">0 min</p>
            </article>
            <article>
              <h3>Line Utilisation</h3>
              <p id="dayKpiUtilisation">0%</p>
            </article>
            <article>
              <h3>Net Run Rate</h3>
              <p id="dayKpiRunRate">0 u/min</p>
            </article>
          </div>
          <section class="panel">
            <h2>Day Visualiser</h2>
            <p class="muted">Horizontal timeline with swimlanes for shift, breaks, production and downtime.</p>
            <div id="dayVisualiserCanvas" class="day-viz-canvas"></div>
          </section>
        </section>

        <section id="lineTrends" class="tab-panel" role="tabpanel">
          <div class="control-row">
            <button id="lineTrendPrevPeriod" class="ghost-btn" type="button">Previous Period</button>
            <label>
              Date
              <input id="lineTrendSelectedDate" type="date" data-manager-date="true" />
            </label>
            <label>
              Shift
              <div id="lineTrendShiftToggle" class="shift-toggle" role="group" aria-label="Line trends shift selector">
                <button type="button" class="shift-option" data-day-shift="Day">Day</button>
                <button type="button" class="shift-option" data-day-shift="Night">Night</button>
                <button type="button" class="shift-option" data-day-shift="Full Day">Full Day</button>
              </div>
            </label>
            <button id="lineTrendNextPeriod" class="ghost-btn" type="button">Next Period</button>
          </div>

          <section class="panel line-trend-shell">
            <div class="line-trend-toolbar">
              <div class="line-trend-range" role="group" aria-label="Line trend range">
                <button type="button" class="ghost-btn" data-line-trend-range="day">Day</button>
                <button type="button" class="ghost-btn" data-line-trend-range="week">Week</button>
                <button type="button" class="ghost-btn" data-line-trend-range="month">Month</button>
                <button type="button" class="ghost-btn" data-line-trend-range="quarter">Quarter</button>
              </div>
              <p id="lineTrendRangeMeta" class="muted"></p>
            </div>

            <div class="line-trend-kpis">
              <article>
                <h3>Units (Current)</h3>
                <p id="lineTrendKpiUnits">0</p>
              </article>
              <article>
                <h3>Downtime (Current)</h3>
                <p id="lineTrendKpiDowntime">0 min</p>
              </article>
              <article>
                <h3>Utilisation (Current)</h3>
                <p id="lineTrendKpiUtilisation">0%</p>
              </article>
              <article>
                <h3>Net Run Rate (Current)</h3>
                <p id="lineTrendKpiRunRate">0 u/min</p>
              </article>
            </div>

            <div class="line-trend-grid">
              <section class="line-trend-panel">
                <h3>Units By Period</h3>
                <div id="lineTrendUnitsChart" class="trend-chart line-trend-chart"></div>
              </section>
              <section class="line-trend-panel">
                <h3>Utilisation and Downtime</h3>
                <div id="lineTrendUtilDownChart" class="trend-chart line-trend-chart"></div>
              </section>
            </div>

            <section class="line-trend-panel">
              <h3>Top Downtime Reasons In Window</h3>
              <div id="lineTrendTopReasons" class="line-trend-reasons"></div>
            </section>
          </section>
        </section>

        <section id="data" class="tab-panel" role="tabpanel">
          <div class="data-layout">
            <div class="data-subtabs" role="tablist" aria-label="Data sections">
              <button class="data-subtab-btn active" data-data-tab="dataShift" type="button">Shift Tracking</button>
              <button class="data-subtab-btn" data-data-tab="dataRun" type="button">Product Runs</button>
              <button class="data-subtab-btn" data-data-tab="dataDown" type="button">Downtime</button>
              <button class="data-subtab-btn" data-data-tab="dataControls" type="button">Controls</button>
            </div>

            <section id="dataShift" class="panel data-section active">
              <h2>Shift Tracking</h2>
              <form id="shiftForm" class="form-grid">
                <input name="date" type="date" required />
                <select name="shift" required>
                  <option value="Day">Day</option>
                  <option value="Night">Night</option>
                  <option value="Full Day">Full Day</option>
                </select>
                <input name="crewOnShift" type="number" min="0" step="1" placeholder="Crew On Shift" required />
                <input name="startTime" placeholder="Start Time" />
                <input name="finishTime" placeholder="Finish Time" />
                <button type="submit">Add Shift Row</button>
              </form>
              <div class="table-wrap"><table id="shiftTable"></table></div>
            </section>

            <section id="dataRun" class="panel data-section">
              <h2>Product Run Tracking</h2>
              <form id="runForm" class="form-grid">
                <input id="runCrewingPattern" name="runCrewingPattern" type="hidden" />
                <input name="date" type="date" required />
                <input name="product" placeholder="Product" required />
                <input name="productionStartTime" placeholder="Production Start Time" />
                <input name="finishTime" placeholder="Finish Time" />
                <input name="unitsProduced" type="number" step="1" placeholder="Units Produced" />
                <button id="runCrewingPatternBtn" class="ghost-btn" type="button">Set Crewing Pattern</button>
                <p id="runCrewingPatternSummary" class="run-crewing-summary">No crewing pattern set.</p>
                <button type="submit">Add Product Row</button>
              </form>
              <div class="table-wrap"><table id="runTable"></table></div>
            </section>

            <section id="dataDown" class="panel data-section">
              <h2>Downtime Tracking</h2>
              <form id="downtimeForm" class="form-grid">
                <input name="date" type="date" required />
                <input name="downtimeStart" placeholder="Downtime Start" />
                <input name="downtimeFinish" placeholder="Downtime Finish" />
                <select name="reasonCategory" id="downtimeReasonCategory" required>
                  <option value="">Reason Group</option>
                  <option value="Equipment">Equipment</option>
                  <option value="Donor Meat">Donor Meat</option>
                  <option value="People">People</option>
                  <option value="Materials">Materials</option>
                  <option value="Other">Other</option>
                </select>
                <select name="reasonDetail" id="downtimeReasonDetail" required></select>
                <input name="reasonNote" id="downtimeReasonNote" placeholder="Reason Notes (optional)" />
                <button type="submit">Add Downtime Row</button>
              </form>
              <div class="table-wrap"><table id="downtimeTable"></table></div>
            </section>

            <section id="dataControls" class="panel data-section">
              <h2>Data Controls</h2>
              <div class="action-row">
                <button id="loadSampleData" type="button">Load Sample Data</button>
                <button id="exportData" type="button">Export JSON</button>
                <button id="exportLineCsv" class="ghost-btn" type="button">Export CSV Report</button>
                <label class="import-label">
                  Import JSON
                  <input id="importData" type="file" accept="application/json" />
                </label>
                <button id="clearData" class="danger" type="button">Clear All</button>
              </div>
              <div id="auditTrail" class="table-wrap"></div>
            </section>
          </div>
        </section>

        <section id="settings" class="tab-panel" role="tabpanel">
          <div class="data-layout">
            <section class="panel">
              <h2>Stage Crew Settings</h2>
              <div class="crew-toggle-wrap">
                <span class="muted">Crew Shift</span>
                <div class="shift-toggle" role="group" aria-label="Crew shift selector">
                  <button type="button" class="shift-option" data-shift="Day">Day</button>
                  <button type="button" class="shift-option" data-shift="Night">Night</button>
                </div>
              </div>
              <p class="muted" id="crewShiftNote">Crew values for Day shift.</p>
              <form id="crewForm" class="crew-grid"></form>
            </section>

            <section class="panel">
              <h2>Stage Max Throughput</h2>
              <p class="muted">Units/min per crew member. Total stage max = (per-crew max) x (crew count).</p>
              <form id="throughputForm" class="crew-grid"></form>
            </section>
          </div>
        </section>
      </main>
    </div>

    <div id="trendModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="trendTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="trendTitle">Stage Performance Trend</h2>
            <p class="muted" id="trendMeta">Click a stage to view performance over time.</p>
          </div>
          <div class="trend-controls">
            <div class="shift-toggle" role="group" aria-label="Trend view mode">
              <button id="trendDaily" type="button" class="shift-option">Daily</button>
              <button id="trendMonthly" type="button" class="shift-option">Monthly</button>
            </div>
            <div class="month-nav">
              <button id="trendPrevMonth" class="ghost-btn" type="button">Prev</button>
              <span id="trendMonthLabel">-</span>
              <button id="trendNextMonth" class="ghost-btn" type="button">Next</button>
            </div>
            <button id="closeTrendModal" class="ghost-btn" type="button">Close</button>
          </div>
        </div>
        <div id="stageTrendChart" class="trend-chart" aria-live="polite"></div>
      </div>
    </div>

    <div id="stageSettingsModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="stageSettingsTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="stageSettingsTitle">Edit Stage</h2>
            <p class="muted">Update this stage for the current production line.</p>
          </div>
          <button id="closeStageSettingsModal" class="ghost-btn" type="button">Close</button>
        </div>
        <form id="stageSettingsForm" class="form-grid">
          <input type="hidden" id="stageSettingsId" />
          <label>
            Stage Name
            <input id="stageSettingsName" required />
          </label>
          <label>
            Type
            <select id="stageSettingsType">
              <option value="main">Main</option>
              <option value="prep">Prep</option>
              <option value="transfer">Transfer</option>
            </select>
          </label>
          <label>
            Day Crew
            <input id="stageSettingsCrewDay" type="number" min="0" step="1" />
          </label>
          <label>
            Night Crew
            <input id="stageSettingsCrewNight" type="number" min="0" step="1" />
          </label>
          <label>
            Max Throughput (u/min per crew)
            <input id="stageSettingsMaxThroughput" type="number" min="0" step="1" />
          </label>
          <label>
            Width (%)
            <input id="stageSettingsWidth" type="number" min="2" step="0.5" />
          </label>
          <label>
            Height (%)
            <input id="stageSettingsHeight" type="number" min="1" step="0.5" />
          </label>
          <button id="saveStageSettings" type="submit">Save Stage</button>
        </form>
      </div>
    </div>

    <div id="runCrewingPatternModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card stage-settings-modal-card" role="dialog" aria-modal="true" aria-labelledby="runCrewingPatternTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="runCrewingPatternTitle">Set Crewing Pattern</h2>
            <p id="runCrewingPatternMeta" class="muted">Set crew values for each non-transfer stage on this run.</p>
          </div>
          <button id="closeRunCrewingPatternModal" class="ghost-btn" type="button">Close</button>
        </div>
        <div id="runCrewingPatternList" class="run-crewing-stage-list"></div>
        <div class="run-crewing-actions">
          <button id="saveRunCrewingPattern" type="button">Save Crewing Pattern</button>
        </div>
      </div>
    </div>

    <div id="builderModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card builder-modal-card" role="dialog" aria-modal="true" aria-labelledby="builderTitle">
        <div class="modal-head">
          <div class="modal-title-block">
            <h2 id="builderTitle">Production Line Builder</h2>
            <p class="muted">Drag stages on the canvas, edit stage settings, then create the line.</p>
          </div>
          <div class="trend-controls">
            <button id="addBuilderStage" type="button">Add Stage</button>
            <button id="createBuilderLine" type="button">Create Line</button>
            <button id="closeBuilderModal" class="ghost-btn" type="button">Close</button>
          </div>
        </div>

        <div class="builder-grid">
          <section class="panel">
            <h3>Line Setup</h3>
            <input id="builderLineName" placeholder="Line Name (e.g. Kebab Line A)" />
            <div class="builder-row builder-row-head">
              <span>#</span>
              <span>Stage Name</span>
              <span>Type</span>
              <span>Crew</span>
              <span>Per-Crew u/min</span>
              <span>Action</span>
            </div>
            <div id="builderStages" class="builder-stages"></div>
          </section>
          <section class="panel">
            <h3>Layout Canvas</h3>
            <div id="builderCanvas" class="builder-canvas"></div>
          </section>
        </div>
      </div>
    </div>

    <script src="app.js"></script>
  </body>
</html>
